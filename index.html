<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic Coin Scanner V10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #05070a; color: #e6edf3; }
        .mono { font-family: 'JetBrains+Mono', monospace; }
        .glass { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(12px); border: 1px solid #30363d; }
        .scan-line {
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            position: absolute;
            width: 100%;
            animation: scan-move 2s linear infinite;
        }
        @keyframes scan-move {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .item-row:hover { background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black text-white italic tracking-tighter">COIN <span class="text-blue-500">MAPPER V10</span></h1>
                <p class="text-[10px] mono text-slate-500 uppercase tracking-[0.3em]">Individual Spatial Verification System</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="document.getElementById('cameraInput').click()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-6 py-4 rounded-2xl font-black transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    ถ่ายภาพ
                    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="handleFile(event)">
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-4 rounded-2xl transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFile(event)">
                </button>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-6">
            <!-- Viewport -->
            <div class="lg:col-span-7 space-y-4">
                <div id="dropZone" class="relative glass rounded-[2rem] overflow-hidden aspect-square border-2 border-slate-800 flex items-center justify-center">
                    <img id="previewImg" class="hidden w-full h-full object-contain" alt="Coins">
                    <div id="placeholder" class="text-center p-8">
                        <p class="text-slate-500 text-sm font-bold uppercase tracking-widest">กรุณาถ่ายภาพหรือเลือกรูปเหรียญ</p>
                    </div>
                    <div id="loader" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20 backdrop-blur-sm">
                        <div class="scan-line"></div>
                        <p class="text-blue-400 font-black mono text-[10px] animate-pulse tracking-[0.4em]">MAPPING SPATIAL COORDINATES...</p>
                    </div>
                </div>
                <div id="summaryCard" class="hidden glass p-6 rounded-3xl border-l-4 border-blue-500">
                    <p id="summaryTxt" class="text-sm italic text-slate-300"></p>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="lg:col-span-5 space-y-4 hidden">
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass p-5 rounded-3xl">
                        <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest mb-1">ยอดรวมเงิน</p>
                        <p id="totalValue" class="text-3xl font-black text-white italic">0.00</p>
                    </div>
                    <div class="glass p-5 rounded-3xl border border-blue-500/30">
                        <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest mb-1">จำนวนเหรียญ</p>
                        <p id="totalCount" class="text-3xl font-black text-white italic">0</p>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden">
                    <div class="px-5 py-3 bg-white/5 border-b border-white/5">
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest italic">Verified Item List</p>
                    </div>
                    <div id="itemList" class="max-h-[400px] overflow-y-auto divide-y divide-white/5 custom-scrollbar">
                        <!-- Items will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyBwkOYDZSoZbX1NrD6pkGH2c2CC_Ffsze8"; 

        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                document.getElementById('previewImg').src = ev.target.result;
                document.getElementById('previewImg').classList.remove('hidden');
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('loader').classList.remove('hidden');
                await startAnalysis(ev.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function startAnalysis(base64) {
            // Stronger instructions to prevent calculation hallucination
            const prompt = `วิเคราะห์ภาพเหรียญไทยแบบระบุรายชิ้น (Individual Coin Mapping)
            
            ข้อบังคับสำคัญ:
            1. ห้ามคำนวณยอดเงินรวมเองเด็ดขาด
            2. ให้สแกนหาเหรียญทีละชิ้น และระบุพิกัดโดยประมาณ (เช่น "บนซ้าย", "กลางขวา")
            3. ตรวจสอบ "ขนาดหน้าเหรียญ" และ "ความหนาของขอบ" เพื่อแยกเหรียญ 1 และ 5 บาท
               - เหรียญ 5: ใหญ่และหนากว่าเหรียญ 1 เสมอ หากมีเหรียญ 1 บาทวางข้างๆ ต้องเห็นความต่างชัดเจน
            4. เหรียญ 10: ต้องมี 2 สี
            5. เหรียญ 2: สีทองล้วน
            
            ส่งค่ากลับมาเป็น JSON รายการเหรียญ:
            {
              "coins": [
                {"id": 1, "value": 10, "location": "บนซ้าย", "features": "เห็นแกนทอง"},
                {"id": 2, "value": 5, "location": "กลาง", "features": "สีเงิน ขนาดใหญ่กว่าเหรียญข้างๆ"},
                {"id": 3, "value": 1, "location": "ล่าง", "features": "สีเงิน ขนาดเล็กสุด"}
              ],
              "ai_observation": "สรุปสภาพแสงหรือการวางซ้อนของเหรียญ"
            }`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const json = await res.json();
                const data = JSON.parse(json.candidates[0].content.parts[0].text);
                processFinalResults(data);
            } catch (err) {
                console.error(err);
                alert("การวิเคราะห์ขัดข้อง กรุณาลองใหม่อีกครั้ง");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function processFinalResults(data) {
            const list = document.getElementById('itemList');
            const coins = data.coins || [];
            list.innerHTML = '';
            
            let totalMoney = 0;
            let count = coins.length;

            // Sort by ID to keep consistent
            coins.sort((a,b) => a.id - b.id);

            coins.forEach(coin => {
                // FIXED CALCULATION BY CODE
                totalMoney += Number(coin.value);

                const div = document.createElement('div');
                div.className = "item-row p-4 flex justify-between items-center transition-all";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-600/20 text-blue-500 border border-blue-500/30 flex items-center justify-center text-[10px] font-black">
                            ${coin.id}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white uppercase italic">เหรียญ ${coin.value} บาท</p>
                            <p class="text-[9px] text-slate-500 uppercase font-mono tracking-tighter">${coin.location} • ${coin.features}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-white italic">${Number(coin.value).toFixed(2)}</p>
                    </div>
                `;
                list.appendChild(div);
            });

            document.getElementById('totalValue').innerText = totalMoney.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('totalCount').innerText = count;
            document.getElementById('summaryTxt').innerText = data.ai_observation;
            
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('summaryCard').classList.remove('hidden');
        }
    </script>
</body>
</html>
