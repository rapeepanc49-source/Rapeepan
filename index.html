<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Scanner V10.3 - Summary Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #05070a; color: #e6edf3; }
        .mono { font-family: 'JetBrains+Mono', monospace; }
        .glass { background: rgba(13, 17, 23, 0.95); backdrop-filter: blur(15px); border: 1px solid #30363d; }
        .scan-line {
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, #60a5fa, transparent);
            position: absolute;
            width: 100%;
            animation: scan-move 1.5s linear infinite;
        }
        @keyframes scan-move {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black text-white italic tracking-tighter uppercase">Forensic <span class="text-blue-500 text-glow">V10.3</span></h1>
                <p class="text-[10px] mono text-slate-500 uppercase tracking-[0.3em]">Statistical Analysis & Individual Mapping</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="document.getElementById('cameraInput').click()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-6 py-4 rounded-2xl font-black transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    ถ่ายภาพ
                    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="handleFile(event)">
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-4 rounded-2xl transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFile(event)">
                </button>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-6">
            <!-- Viewport -->
            <div class="lg:col-span-6 space-y-4">
                <div id="dropZone" class="relative glass rounded-[2.5rem] overflow-hidden aspect-square border-2 border-slate-800 flex items-center justify-center shadow-2xl">
                    <img id="previewImg" class="hidden w-full h-full object-contain p-2" alt="Coins">
                    <div id="placeholder" class="text-center p-8">
                        <p class="text-slate-500 text-sm font-bold uppercase tracking-widest italic">Ready for Forensic Analysis</p>
                    </div>
                    <div id="loader" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-20 backdrop-blur-md">
                        <div class="scan-line"></div>
                        <p class="text-blue-400 font-black mono text-[11px] animate-pulse tracking-[0.5em] mb-2 uppercase text-center">Neural Scanning...</p>
                        <p id="loadingMsg" class="text-[9px] text-slate-500 italic text-center uppercase tracking-widest">Processing Image Data</p>
                    </div>
                </div>
            </div>

            <!-- Stats & Tables -->
            <div id="dashboard" class="lg:col-span-6 space-y-4 hidden">
                <!-- Summary Totals -->
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="glass p-6 rounded-[2rem] bg-gradient-to-br from-blue-600/10 to-transparent border-blue-500/20">
                        <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest mb-1">ยอดเงินสุทธิ</p>
                        <p id="totalValue" class="text-4xl font-black text-white italic tracking-tighter">0.00</p>
                    </div>
                    <div class="glass p-6 rounded-[2rem]">
                        <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest mb-1">จำนวนเหรียญรวม</p>
                        <p id="totalCount" class="text-4xl font-black text-white italic tracking-tighter">0</p>
                    </div>
                </div>

                <!-- NEW: Summary Table by Denomination -->
                <div class="glass rounded-[2rem] overflow-hidden border-emerald-500/20">
                    <div class="px-6 py-4 bg-emerald-500/5 border-b border-white/5 flex justify-between items-center">
                        <p class="text-[10px] font-black uppercase text-emerald-500 tracking-[0.2em] italic">สรุปตามประเภทเหรียญ</p>
                        <span class="text-[9px] font-mono text-slate-500">AGGREGATED DATA</span>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-[9px] font-black uppercase text-slate-400 tracking-widest">
                            <tr>
                                <th class="px-6 py-3">ประเภท</th>
                                <th class="px-6 py-3 text-center">จำนวน</th>
                                <th class="px-6 py-3 text-right">รวมเป็นเงิน</th>
                            </tr>
                        </thead>
                        <tbody id="statRows" class="text-sm divide-y divide-white/5">
                            <!-- Injected by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Individual Item Log -->
                <div class="glass rounded-[2rem] overflow-hidden">
                    <div class="px-6 py-4 bg-white/5 border-b border-white/5">
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest italic uppercase">รายการตรวจสอบพิกัดรายชิ้น</p>
                    </div>
                    <div id="itemList" class="max-h-[250px] overflow-y-auto divide-y divide-white/5 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="glass max-w-sm w-full p-8 rounded-[2.5rem] border-red-500/30 text-center">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20 text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <h3 class="text-lg font-black text-white mb-2 italic uppercase">Analysis Failed</h3>
            <p id="errorTxt" class="text-sm text-slate-400 italic mb-6 leading-relaxed">System encountered a temporary issue.</p>
            <button onclick="closeError()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-2xl transition-all active:scale-95 uppercase text-[10px] tracking-widest">Dismiss</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyBwkOYDZSoZbX1NrD6pkGH2c2CC_Ffsze8";

        function closeError() { document.getElementById('errorModal').classList.add('hidden'); }
        function showError(msg) { 
            document.getElementById('errorTxt').innerText = msg;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                document.getElementById('previewImg').src = ev.target.result;
                document.getElementById('previewImg').classList.remove('hidden');
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('loader').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                await analyzeCoins(ev.target.result);
            };
            reader.readAsDataURL(file);
        }

        const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    if (retries > 0 && (res.status >= 500 || res.status === 429)) {
                        await new Promise(r => setTimeout(r, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw new Error(`Status: ${res.status}`);
                }
                return res;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        };

        async function analyzeCoins(base64) {
            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.innerText = "Analyzing Spatial Properties...";

            const prompt = `Identify Thai coins in this image. 
            Mandatory: Identify EACH coin individually.
            Logic for 1 vs 5 THB: 5 THB is noticeably larger and thicker. If you see two silver coins, the smaller one is 1 THB.
            Return ONLY JSON.
            
            JSON Structure:
            {
              "detected_coins": [
                {"id": 1, "denom": 10, "loc": "Top-Left", "note": "Bimetallic check passed"}
              ]
            }`;

            try {
                if (!apiKey) throw new Error("API Key Missing");

                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const json = await res.json();
                const data = JSON.parse(json.candidates[0].content.parts[0].text);
                renderEverything(data);
            } catch (err) {
                showError("ขออภัย ระบบหนาแน่นชั่วคราว กรุณาลองใหม่ในอีกสักครู่ (" + err.message + ")");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function renderEverything(data) {
            const coins = data.detected_coins || [];
            const itemList = document.getElementById('itemList');
            const statRows = document.getElementById('statRows');
            
            itemList.innerHTML = '';
            statRows.innerHTML = '';

            // 1. Initial Math
            let totalMoney = 0;
            const stats = {
                10: { count: 0, color: 'text-orange-400' },
                5: { count: 0, color: 'text-slate-300' },
                2: { count: 0, color: 'text-yellow-400' },
                1: { count: 0, color: 'text-slate-400' }
            };

            coins.forEach(coin => {
                const val = Number(coin.denom);
                totalMoney += val;
                if (stats[val]) stats[val].count++;

                // Render Item Row
                const div = document.createElement('div');
                div.className = "p-4 flex justify-between items-center hover:bg-white/[0.02] transition-colors";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-xl bg-blue-600/10 text-blue-500 border border-blue-500/20 flex items-center justify-center text-[10px] font-black italic">
                            #${coin.id}
                        </div>
                        <div>
                            <p class="text-xs font-black text-white italic">เหรียญ ${val} บาท</p>
                            <p class="text-[9px] text-slate-500 font-mono tracking-tighter uppercase">${coin.loc} • ${coin.note}</p>
                        </div>
                    </div>
                `;
                itemList.appendChild(div);
            });

            // 2. Render Statistical Table
            const denoms = [10, 5, 2, 1];
            denoms.forEach(d => {
                const s = stats[d];
                if (s.count > 0) {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/[0.02] transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold ${s.color} italic">เหรียญ ${d} บาท</td>
                        <td class="px-6 py-4 text-center font-black text-white">${s.count}</td>
                        <td class="px-6 py-4 text-right font-black text-white italic">${(s.count * d).toFixed(2)}</td>
                    `;
                    statRows.appendChild(tr);
                }
            });

            // 3. Update Totals
            document.getElementById('totalValue').innerText = totalMoney.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('totalCount').innerText = coins.length;
            document.getElementById('dashboard').classList.remove('hidden');
        }
    </script>
</body>
</html>
